<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GeoDash World 2: Mobile</title>
    <style>
        /* Estilos optimizados para móvil */
        body { 
            margin: 0; 
            overflow: hidden; 
            background-color: #111; 
            font-family: 'Segoe UI', sans-serif;
            touch-action: none; /* Vital: Evita zoom y scroll al tocar */
            user-select: none; /* Evita seleccionar texto al tocar rápido */
            -webkit-user-select: none;
        }
        canvas { display: block; }
        
        #ui { 
            position: absolute; top: 20px; left: 20px; 
            color: #fff; font-size: 28px; font-weight: bold; 
            text-shadow: 2px 2px #000; pointer-events: none; z-index: 10;
        }

        #startScreen {
            position: absolute; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            color: white; z-index: 100;
        }

        /* Botón más grande para dedos */
        button {
            padding: 25px 50px; font-size: 28px; cursor: pointer;
            background: #27ae60; color: white; border: none; 
            border-radius: 15px; font-weight: bold; transition: 0.2s;
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
            -webkit-tap-highlight-color: transparent; /* Quita el brillo azul al tocar */
        }
        button:active { transform: scale(0.95); background: #2ecc71; }
    </style>
</head>
<body>

    <div id="startScreen">
        <h1 style="color: #2ecc71; margin-bottom: 5px; font-size: 40px;">MUNDO 2</h1>
        <h3 style="margin-bottom: 40px; color: #bdc3c7;">PLATAFORMAS MÓVIL</h3>
        <button id="startBtn">¡TOCAR PARA JUGAR!</button>
    </div>

    <div id="ui">SCORE: <span id="score">0</span></div>
    <canvas id="gameCanvas"></canvas>

    <audio id="bgMusic" loop>
        <source src="Download.mp4" type="audio/mp4">
    </audio>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreElement = document.getElementById('score');
        const bgMusic = document.getElementById('bgMusic');
        const startScreen = document.getElementById('startScreen');
        const startBtn = document.getElementById('startBtn');

        // Función para ajustar tamaño
        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resize);
        resize(); // Llamar al inicio

        let score = 0;
        let gameActive = false;
        let frameCount = 0;
        let gameSpeed = 8;
        let elements = []; 

        const player = {
            x: 100, // Un poco más a la izquierda para pantallas pequeñas
            y: 0, size: 45,
            color: "#fff", dy: 0, jumpForce: 15,
            gravity: 0.8, grounded: false, rotation: 0
        };

        function getBackgroundColor() {
            if (score >= 150) return "#000000";
            if (score >= 100) return "#c0392b";
            if (score >= 50)  return "#f1c40f";
            return "#27ae60"; 
        }

        function startGame() {
            startScreen.style.display = 'none';
            score = 0;
            scoreElement.innerText = "0";
            elements = [];
            gameActive = true;
            
            // Reiniciar jugador
            player.y = canvas.height - 100;
            player.dy = 0;
            
            // En móviles el audio requiere interacción directa
            bgMusic.currentTime = 0;
            bgMusic.play().catch(e => console.log("Error audio mobile:", e));
            
            requestAnimationFrame(draw);
        }

        // Usar evento touchstart para el botón también
        startBtn.addEventListener('touchstart', (e) => {
            e.preventDefault(); // Evitar doble disparo
            startGame();
        });
        startBtn.addEventListener('click', startGame); // Fallback para PC

        function spawnPattern() {
            const type = Math.random();
            const groundY = canvas.height - 10;

            if (type < 0.45) { // Un poco más de probabilidad de plataformas
                elements.push({
                    type: 'platform',
                    x: canvas.width,
                    y: groundY - 150 - (Math.random() * 100),
                    w: 200,
                    h: 30
                });
            } else {
                elements.push({
                    type: 'spike',
                    x: canvas.width,
                    y: groundY - 50,
                    w: 50,
                    h: 50
                });
            }
        }

        function update() {
            if (!gameActive) return;

            // Físicas
            player.dy += player.gravity;
            player.y += player.dy;

            let onAnyPlatform = false;
            const groundY = canvas.height - 10;

            if (player.y + player.size > groundY) {
                player.y = groundY - player.size;
                player.dy = 0;
                player.grounded = true;
                onAnyPlatform = true;
            }

            // Lógica
            frameCount++;
            if (frameCount % 70 === 0) spawnPattern();

            for (let i = elements.length - 1; i >= 0; i--) {
                let el = elements[i];
                el.x -= gameSpeed;

                if (el.type === 'platform') {
                    if (player.x + player.size > el.x && 
                        player.x < el.x + el.w &&
                        player.y + player.size > el.y &&
                        player.y + player.size < el.y + el.h + player.dy + 5 &&
                        player.dy >= 0) {
                        
                        player.y = el.y - player.size;
                        player.dy = 0;
                        player.grounded = true;
                        onAnyPlatform = true;
                    }
                } else if (el.type === 'spike') {
                    // Hitbox un poco más pequeña para móviles (más perdonadora)
                    if (player.x + player.size - 12 > el.x && 
                        player.x + 12 < el.x + el.w &&
                        player.y + player.size > el.y + 10) {
                        gameOver();
                    }
                }

                if (el.x + el.w < 0) {
                    elements.splice(i, 1);
                    score++;
                    scoreElement.innerText = score;
                    gameSpeed += 0.05;
                }
            }

            if (!onAnyPlatform) {
                player.grounded = false;
                player.rotation += 7;
            } else {
                player.rotation = Math.round(player.rotation / 90) * 90;
            }

            if (score >= 160) victory();
        }

        function draw() {
            ctx.fillStyle = getBackgroundColor();
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            ctx.fillStyle = "rgba(255,255,255,0.2)";
            ctx.fillRect(0, canvas.height - 10, canvas.width, 10);

            elements.forEach(el => {
                if (el.type === 'platform') {
                    ctx.fillStyle = "#ecf0f1";
                    ctx.fillRect(el.x, el.y, el.w, el.h);
                    ctx.strokeStyle = "#34495e";
                    ctx.lineWidth = 2;
                    ctx.strokeRect(el.x, el.y, el.w, el.h);
                } else {
                    ctx.fillStyle = "#2c3e50";
                    ctx.beginPath();
                    ctx.moveTo(el.x, el.y + el.h);
                    ctx.lineTo(el.x + el.w/2, el.y);
                    ctx.lineTo(el.x + el.w, el.y + el.h);
                    ctx.fill();
                    ctx.strokeStyle = "white";
                    ctx.stroke();
                }
            });

            ctx.save();
            ctx.translate(player.x + player.size/2, player.y + player.size/2);
            ctx.rotate(player.rotation * Math.PI / 180);
            ctx.fillStyle = player.color;
            ctx.fillRect(-player.size/2, -player.size/2, player.size, player.size);
            ctx.strokeStyle = "black";
            ctx.lineWidth = 2;
            ctx.strokeRect(-player.size/2, -player.size/2, player.size, player.size);
            ctx.restore();

            if (gameActive) {
                update();
                requestAnimationFrame(draw);
            }
        }

        function jump() {
            if (player.grounded && gameActive) {
                player.dy = -player.jumpForce;
                player.grounded = false;
            }
        }

        function gameOver() {
            gameActive = false;
            bgMusic.pause();
            // Pequeño delay para que no se reinicie instantáneamente si sigues tocando
            setTimeout(() => {
                alert("¡GAME OVER! Score: " + score);
                location.reload();
            }, 100);
        }

        function victory() {
            gameActive = false;
            bgMusic.pause();
            alert("¡MUNDO 2 COMPLETADO!");
            location.reload();
        }

        // --- SISTEMA DE INPUT MÓVIL ---
        // Prevenir comportamiento por defecto para que no haga scroll
        window.addEventListener('touchstart', (e) => {
            if(gameActive) {
                jump();
                e.preventDefault(); // Evita scroll y zoom
            }
        }, {passive: false});

        // Soporte PC
        window.addEventListener('keydown', (e) => { 
            if (e.code === 'Space' || e.code === 'ArrowUp') jump(); 
        });
        window.addEventListener('mousedown', (e) => {
            // Evitar doble salto si se dispara touch y mouse a la vez
            if(e.sourceCapabilities && e.sourceCapabilities.firesTouchEvents) return;
            jump();
        });

    </script>
</body>
</html>