<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GeoDash: World 4 (Gravity)</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #111; font-family: 'Segoe UI', sans-serif; }
        canvas { display: block; }
        
        #ui { 
            position: absolute; top: 20px; left: 20px; 
            color: #fff; font-size: 28px; font-weight: bold; 
            text-shadow: 2px 2px #000; pointer-events: none; z-index: 10;
        }

        #startScreen {
            position: absolute; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            color: white; z-index: 100;
        }

        button {
            padding: 20px 40px; font-size: 24px; cursor: pointer;
            background: #c0392b; color: white; border: none; 
            border-radius: 10px; font-weight: bold; transition: 0.2s;
            box-shadow: 0 0 20px rgba(192, 57, 43, 0.6);
        }
        button:hover { transform: scale(1.1); background: #e74c3c; }
    </style>
</head>
<body>

    <div id="startScreen">
        <h1 style="color: #c0392b; margin-bottom: 5px;">MUNDO 4</h1>
        <h3 style="margin-bottom: 30px; color: #bdc3c7;">GRAVITY FLIP MODE</h3>
        <button onclick="startGame()">¡DESAFIAR GRAVEDAD!</button>
    </div>

    <div id="ui">SCORE: <span id="score">0</span></div>
    <canvas id="gameCanvas"></canvas>

    <audio id="bgMusic" loop>
        <source src="Download.mp4" type="audio/mp4">
    </audio>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreElement = document.getElementById('score');
        const bgMusic = document.getElementById('bgMusic');
        const startScreen = document.getElementById('startScreen');

        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        let score = 0;
        let gameActive = false;
        let frameCount = 0;
        let gameSpeed = 10; 
        let elements = []; 
        
        // Variables de estado
        let canSwitchGravity = true; // Para evitar doble cambio en un solo clic

        const player = {
            x: 150, y: 0, size: 45,
            color: "#fff", dy: 0, 
            mode: "cube", // "cube" o "gravity"
            inverted: false, // ¿Está en el techo?
            rotation: 0,
            grounded: false
        };

        // --- COLORES (Empieza en ROJO) ---
        function getBackgroundColor() {
            if (score >= 150) return "#000000"; // Negro (Final)
            if (score >= 100) return "#2c3e50"; // Gris Oscuro
            if (score >= 50)  return "#8e44ad"; // Morado Oscuro
            return "#c0392b"; // Rojo (Inicio)
        }

        function startGame() {
            startScreen.style.display = 'none';
            score = 0;
            scoreElement.innerText = "0";
            elements = [];
            gameSpeed = 10;
            gameActive = true;
            
            // Reset Player
            player.mode = "cube";
            player.inverted = false;
            player.y = canvas.height - 100;
            player.dy = 0;
            player.rotation = 0;
            
            bgMusic.currentTime = 0;
            bgMusic.play().catch(e => console.log(e));
            requestAnimationFrame(draw);
        }

        function spawnPattern() {
            const groundY = canvas.height - 10;
            const ceilingY = 20; 

            // 1. GENERAR PORTAL MORADO (Gravity)
            if (player.mode === "cube" && score > 8 && Math.random() > 0.95) {
                elements.push({
                    type: 'portal',
                    x: canvas.width,
                    y: groundY - 180,
                    w: 60, h: 100
                });
                return;
            }

            // 2. OBSTÁCULOS
            if (player.mode === "cube") {
                // Modo Normal
                elements.push({
                    type: 'spike',
                    x: canvas.width,
                    y: groundY - 60,
                    w: 50, h: 60,
                    flipped: false
                });
            } else {
                // MODO GRAVEDAD (Arriba y Abajo)
                // Generamos pinchos en el lado OPUESTO al jugador para obligarlo a cambiar
                // O en el mismo lado para obligarlo a mantenerse.
                
                const type = Math.random();
                
                if (type > 0.5) {
                    // Pincho en el SUELO
                    elements.push({
                        type: 'spike',
                        x: canvas.width,
                        y: groundY - 60,
                        w: 50, h: 60,
                        flipped: false
                    });
                } else {
                    // Pincho en el TECHO
                    elements.push({
                        type: 'spike',
                        x: canvas.width,
                        y: ceilingY, 
                        w: 50, h: 60,
                        flipped: true
                    });
                }
            }
        }

        function update() {
            if (!gameActive) return;
            if (score >= 160) { victory(); return; }

            const groundY = canvas.height - 10;
            const ceilingY = 20; // Margen superior visual

            // --- LÓGICA DE FÍSICAS ---
            if (player.mode === "cube") {
                // FÍSICA NORMAL
                player.dy += 1.2; 
                player.y += player.dy;
                player.rotation += 8;

                if (player.y + player.size > groundY) {
                    player.y = groundY - player.size;
                    player.dy = 0;
                    player.grounded = true;
                    player.rotation = 0;
                } else {
                    player.grounded = false;
                }
            } 
            else if (player.mode === "gravity") {
                // FÍSICA ARRIBA Y ABAJO (Gravity Ball)
                
                // Aplicar gravedad según inversión
                if (player.inverted) {
                    player.dy -= 1.5; // Cae hacia arriba (gravedad negativa)
                } else {
                    player.dy += 1.5; // Cae hacia abajo (gravedad positiva)
                }

                player.y += player.dy;
                player.rotation += 10; // Gira rápido al cambiar

                // Colisión SUELO
                if (!player.inverted && player.y + player.size > groundY) {
                    player.y = groundY - player.size;
                    player.dy = 0;
                    player.grounded = true;
                    canSwitchGravity = true; // Recargar habilidad al tocar superficie
                    player.rotation = 0;
                }
                // Colisión TECHO
                else if (player.inverted && player.y < ceilingY) {
                    player.y = ceilingY;
                    player.dy = 0;
                    player.grounded = true;
                    canSwitchGravity = true; // Recargar habilidad
                    player.rotation = 0;
                } 
                else {
                    player.grounded = false;
                }
            }

            // --- OBSTÁCULOS ---
            frameCount++;
            let frequency = player.mode === "gravity" ? 35 : 60;
            if (frameCount % frequency === 0) spawnPattern();

            for (let i = elements.length - 1; i >= 0; i--) {
                let el = elements[i];
                el.x -= gameSpeed;

                // Hitbox con "padding" para no ser injustos
                const pad = 12;

                if (
                    player.x + pad < el.x + el.w - pad &&
                    player.x + player.size - pad > el.x + pad &&
                    player.y + player.size - pad > el.y + pad &&
                    player.y + pad < el.y + el.h - pad
                ) {
                    if (el.type === 'portal') {
                        player.mode = "gravity";
                        elements.splice(i, 1);
                        // Flash Visual
                        ctx.fillStyle = "white";
                        ctx.fillRect(0,0,canvas.width, canvas.height);
                        continue;
                    } else {
                        gameOver();
                    }
                }

                if (el.x + el.w < 0) {
                    elements.splice(i, 1);
                    score++;
                    scoreElement.innerText = score;
                    gameSpeed += 0.03;
                }
            }
        }

        function draw() {
            // Fondo
            ctx.fillStyle = getBackgroundColor();
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Techo y Suelo visuales
            ctx.fillStyle = "rgba(0,0,0,0.5)";
            ctx.fillRect(0, 0, canvas.width, 20); // Techo
            ctx.fillRect(0, canvas.height - 10, canvas.width, 10); // Suelo

            // Elementos
            elements.forEach(el => {
                if (el.type === 'portal') {
                    // Portal Morado
                    ctx.fillStyle = "#8e44ad";
                    ctx.fillRect(el.x, el.y, el.w, el.h);
                    ctx.strokeStyle = "#fff";
                    ctx.lineWidth = 4;
                    ctx.strokeRect(el.x, el.y, el.w, el.h);
                    // Círculo interior
                    ctx.beginPath();
                    ctx.fillStyle = "black";
                    ctx.arc(el.x + el.w/2, el.y + el.h/2, 15, 0, Math.PI*2);
                    ctx.fill();
                } else {
                    // Pinchos
                    ctx.fillStyle = "#2c3e50";
                    ctx.beginPath();
                    if (el.flipped) { // Cuelga del techo
                        ctx.moveTo(el.x, el.y);
                        ctx.lineTo(el.x + el.w / 2, el.y + el.h);
                        ctx.lineTo(el.x + el.w, el.y);
                    } else { // En el suelo
                        ctx.moveTo(el.x, el.y + el.h);
                        ctx.lineTo(el.x + el.w / 2, el.y);
                        ctx.lineTo(el.x + el.w, el.y + el.h);
                    }
                    ctx.fill();
                    ctx.strokeStyle = "white";
                    ctx.lineWidth = 2;
                    ctx.stroke();
                }
            });

            // Jugador
            ctx.save();
            ctx.translate(player.x + player.size/2, player.y + player.size/2);
            ctx.rotate(player.rotation * Math.PI / 180);
            
            // Dibujar Cubo
            ctx.fillStyle = player.color;
            ctx.fillRect(-player.size/2, -player.size/2, player.size, player.size);
            ctx.strokeStyle = "black";
            ctx.lineWidth = 3;
            ctx.strokeRect(-player.size/2, -player.size/2, player.size, player.size);
            
            // Si está en modo gravedad, dibujamos un indicador extra
            if (player.mode === "gravity") {
                ctx.fillStyle = "#8e44ad"; // Centro morado
                ctx.fillRect(-10, -10, 20, 20);
            } else {
                // Cara normal
                ctx.fillStyle = "black";
                ctx.fillRect(5, -10, 10, 10);
            }
            
            ctx.restore();

            if (gameActive) {
                update();
                requestAnimationFrame(draw);
            }
        }

        // --- CONTROLES UNIFICADOS ---
        function handleInput(e) {
            // Prevenir comportamiento por defecto
            if (e.type === 'keydown' && e.code !== 'Space' && e.code !== 'ArrowUp') return;
            if (e.type === 'touchstart') e.preventDefault();
            
            if (!gameActive) return;

            // 1. MODO CUBO (Salto normal)
            if (player.mode === "cube") {
                if (player.grounded) {
                    player.dy = -20; // Salto alto
                    player.grounded = false;
                }
            } 
            // 2. MODO GRAVEDAD (Invertir)
            else if (player.mode === "gravity") {
                if (player.grounded && canSwitchGravity) {
                    player.inverted = !player.inverted; // Cambiar estado
                    player.grounded = false; // Ya no estás en el suelo/techo
                    canSwitchGravity = false; // Esperar a tocar superficie de nuevo
                }
            }
        }

        window.addEventListener('keydown', handleInput);
        window.addEventListener('mousedown', handleInput);
        window.addEventListener('touchstart', handleInput, {passive: false});

        function gameOver() {
            gameActive = false;
            bgMusic.pause();
            setTimeout(() => alert("¡TE ESTRELLASTE! Score: " + score), 10);
            location.reload();
        }

        function victory() {
            gameActive = false;
            bgMusic.pause();
            alert("¡GRAVEDAD DOMINADA! Eres un maestro.");
            location.reload();
        }

        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        });
    </script>
</body>
</html>